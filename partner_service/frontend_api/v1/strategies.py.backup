# ğŸ“ app/api/v1/strategies.py
"""
ì „ëµ API ì—”ë“œí¬ì¸íŠ¸ - ë³¸ì‚¬ì„œë²„ ì‹ í˜¸ ì œê³µ ì‹œìŠ¤í…œ
Created: 2025.06.24 00:48 KST
Fixed: 2025.06.24 00:52 KST - ê¸°ì¡´ strategy_base.py êµ¬ì¡° í˜¸í™˜
Purpose: ì‚¬ìš©ìì„œë²„ê°€ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ì „ëµ ì‹ í˜¸ API
"""
from fastapi import APIRouter, HTTPException, Query
from typing import List, Optional, Dict, Any
from datetime import datetime
from pydantic import BaseModel
import asyncio
import logging

# ê¸°ì¡´ êµ¬ì¡°ì™€ í˜¸í™˜ë˜ëŠ” import (ì¼ë‹¨ ê¸°ë³¸ë§Œ)
from app.strategies.utils.okx_client_fixed import FixedMarketScanner

logger = logging.getLogger(__name__)
router = APIRouter()

# ì‘ë‹µ ëª¨ë¸ ì •ì˜
class SignalResponse(BaseModel):
    """ì‹ í˜¸ ì‘ë‹µ ëª¨ë¸"""
    symbol: str
    signal_type: str  # BUY, SELL, HOLD
    confidence: float
    timestamp: datetime
    strategy_name: str
    conditions_met: List[str]
    market_data: Dict[str, Any]

class StrategyListResponse(BaseModel):
    """ì „ëµ ëª©ë¡ ì‘ë‹µ"""
    strategy_id: str
    strategy_name: str
    description: str
    category: str
    is_active: bool

class MarketScanResponse(BaseModel):
    """ì‹œì¥ ìŠ¤ìº” ì‘ë‹µ"""
    scan_timestamp: datetime
    total_coins_scanned: int
    signals_found: int
    signals: List[SignalResponse]
    scan_duration_ms: int

# ì „ì—­ ìŠ¤ìºë„ˆ ì¸ìŠ¤í„´ìŠ¤
_market_scanner: Optional[FixedMarketScanner] = None

async def get_market_scanner():
    """ë§ˆì¼“ ìŠ¤ìºë„ˆ ì‹±ê¸€í†¤ íŒ¨í„´"""
    global _market_scanner
    if _market_scanner is None:
        _market_scanner = FixedMarketScanner()
        await _market_scanner.initialize()
    return _market_scanner

@router.get("/strategies", response_model=List[StrategyListResponse])
async def get_available_strategies():
    """ì‚¬ìš© ê°€ëŠ¥í•œ ì „ëµ ëª©ë¡ ì¡°íšŒ"""
    strategies = [
        {
            "strategy_id": "basic_scanning",
            "strategy_name": "ê¸°ë³¸ ìŠ¤ìºë‹ ì „ëµ",
            "description": "ì‹¤ì‹œê°„ ì‹œì¥ ìŠ¤ìº”ì„ í†µí•œ ë³€ë™ì„± ê¸°ë°˜ ì‹ í˜¸ ìƒì„±",
            "category": "market_scanning",
            "is_active": True
        },
        {
            "strategy_id": "scalping_strategy", 
            "strategy_name": "ë‹¨íƒ€ë¡œ ì „ëµ",
            "description": "ê¸°ìˆ ì  ë¶„ì„ ê¸°ë°˜ ë‹¨íƒ€ ë§¤ë§¤ ì „ëµ",
            "category": "technical_analysis",
            "is_active": True
        }
    ]
    
    return [StrategyListResponse(**strategy) for strategy in strategies]

@router.get("/strategies/basic_scanning/signals", response_model=MarketScanResponse)
async def get_basic_scanning_signals(
    limit: int = Query(default=30, description="ìŠ¤ìº”í•  ì½”ì¸ ìˆ˜", ge=1, le=100)
):
    """ê¸°ë³¸ ìŠ¤ìºë‹ ì „ëµ ì‹ í˜¸ ì¡°íšŒ"""
    start_time = datetime.now()
    
    try:
        scanner = await get_market_scanner()
        signals_data = await scanner.scan_top_coins(limit)
        
        # ì‘ë‹µ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        signals = []
        for signal_data in signals_data:
            signal_response = SignalResponse(
                symbol=signal_data['symbol'],
                signal_type=signal_data['signal_type'],
                confidence=signal_data['confidence'],
                timestamp=signal_data['market_data']['timestamp'],
                strategy_name="ê¸°ë³¸ ìŠ¤ìºë‹ ì „ëµ",
                conditions_met=signal_data['conditions_met'],
                market_data=signal_data['market_data']
            )
            signals.append(signal_response)
        
        scan_duration = (datetime.now() - start_time).total_seconds() * 1000
        
        return MarketScanResponse(
            scan_timestamp=start_time,
            total_coins_scanned=limit,
            signals_found=len(signals),
            signals=signals,
            scan_duration_ms=int(scan_duration)
        )
        
    except Exception as e:
        logger.error(f"ê¸°ë³¸ ìŠ¤ìºë‹ ì‹ í˜¸ ì¡°íšŒ ì˜¤ë¥˜: {e}")
        raise HTTPException(status_code=500, detail=f"ì‹ í˜¸ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}")

@router.get("/strategies/health")
async def strategy_health_check():
    """ì „ëµ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬"""
    try:
        scanner = await get_market_scanner()
        test_tickers = await scanner.okx_client.get_multiple_tickers()
        
        return {
            "status": "healthy",
            "timestamp": datetime.now(),
            "okx_connection": "ok" if test_tickers else "error",
            "strategies_loaded": 2,
            "message": "ì „ëµ ì‹œìŠ¤í…œ ì •ìƒ ë™ì‘ ì¤‘"
        }
        
    except Exception as e:
        return {
            "status": "error", 
            "timestamp": datetime.now(),
            "error": str(e),
            "message": "ì „ëµ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ"
        }
